generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Party {
  id         String   @id @default(uuid())
  code       String   @unique
  title      String
  contentType String
  contentUrl String
  visibility String   @default("private")
  maxSeats   Int
  theme      String?
  currentIndex Int     @default(0)
  micLocked  Boolean  @default(false)
  seatLocked Boolean  @default(false)
  status     String   @default("live")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  participants Participant[]
  messages   Message[]
  playback   PlaybackState?
  playlist   PlaylistItem[]
  gameSessions GameSession[]
}

model Leaderboard {
  id           String   @id @default(uuid())
  displayName  String
  score        Int
  wavesCleared Int
  duration     Int      // in seconds
  mode         String   // "solo" or "coop"
  partyId      String?
  createdAt    DateTime @default(now())
}

model UserUnlock {
  id           String   @id @default(uuid())
  displayName  String   @unique
  unlockedSkins String[]
  totalScore    Int      @default(0)
  maxWave       Int      @default(0)
}

model Participant {
  id           String   @id @default(uuid())
  party        Party    @relation(fields: [partyId], references: [id])
  partyId      String
  displayName  String
  seatId       String
  isHost       Boolean  @default(false)
  muted        Boolean  @default(false)
  joinedAt     DateTime @default(now())
  leftAt       DateTime?
  messages     Message[]
  scores       PlayerScore[]
  hostedSessions GameSession[] @relation("HostedGameSessions")
}

model Message {
  id            String   @id @default(uuid())
  party         Party    @relation(fields: [partyId], references: [id])
  partyId       String
  participant   Participant? @relation(fields: [participantId], references: [id])
  participantId String?
  seatId        String
  displayName   String
  text          String
  createdAt     DateTime @default(now())
}

model PlaybackState {
  party       Party   @relation(fields: [partyId], references: [id])
  partyId     String  @id
  playing     Boolean @default(false)
  currentTime Float   @default(0)
  updatedAt   DateTime @updatedAt
}

model PlaylistItem {
  id          String   @id @default(uuid())
  party       Party    @relation(fields: [partyId], references: [id])
  partyId     String
  orderIndex  Int
  contentType String
  contentUrl  String
  title       String?
  createdAt   DateTime @default(now())
}

model Game {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  sessions    GameSession[]
}

model GameSession {
  id         Int      @id @default(autoincrement())
  partyCode  String
  partyId    String
  gameId     Int
  hostId     String
  state      Json
  status     String   @default("idle")
  metadata   Json?
  startedAt  DateTime?
  endedAt    DateTime?
  createdAt  DateTime @default(now())

  party      Party        @relation(fields: [partyId], references: [id])
  game       Game         @relation(fields: [gameId], references: [id])
  host       Participant  @relation("HostedGameSessions", fields: [hostId], references: [id])
  scores     PlayerScore[]

  @@index([partyCode])
}

model PlayerScore {
  id            Int     @id @default(autoincrement())
  sessionId     Int
  participantId String
  score         Int     @default(0)

  session       GameSession @relation(fields: [sessionId], references: [id])
  participant   Participant @relation(fields: [participantId], references: [id])

  @@unique([sessionId, participantId])
}

model MemeCache {
  id         Int      @id @default(autoincrement())
  inputHash  String   @unique
  b64_png    String?  @db.Text
  s3Key      String?
  width      Int
  height     Int
  aspect     String
  createdAt  DateTime @default(now())
  jobs       MemeJob[]
}

model MemeJob {
  id         Int      @id @default(autoincrement())
  jobId      String   @unique
  inputHash  String
  status     String
  attempts   Int      @default(0)
  error      String?
  payload    Json
  requiresClientKey Boolean @default(false)
  resultId   Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  result     MemeCache? @relation(fields: [resultId], references: [id])
}
